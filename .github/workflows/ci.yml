name: Continuous Integration

env:
  HUSKY: 0

on: [push]

jobs:
  prepare:
    name: Prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - uses: ./.github/prepare

  checkCommitMessage:
    timeout-minutes: 3
    name: Check Commit Message
    runs-on: ubuntu-latest
    needs: [prepare]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: ./.github/prepare      
      - name: Check last commit message
        id: commitlint-main
        if: github.ref_name == 'main'
        run: pnpm commitlint --last --verbose

      - name: Check commit message
        id: commitlint-not_main
        if: github.ref_name != 'main'
        run: pnpm commitlint --from=origin/main --verbose

  typecheck:
    timeout-minutes: 3
    name: Type Check
    runs-on: ubuntu-latest
    needs: [checkCommitMessage]
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/prepare      
      - name: Type Check
        id: pnpm-typecheck
        run: pnpm typecheck

  lint:
    timeout-minutes: 3
    name: Lint
    runs-on: ubuntu-latest
    needs: [checkCommitMessage]
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/prepare
      - name: Lint
        id: pnpm-lint
        run: pnpm lint

  test:
    timeout-minutes: 3
    name: Test
    runs-on: ubuntu-latest
    needs: [checkCommitMessage]
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/prepare
      - name: Test
        id: pnpm-ci-test-main
        run: pnpm test:all

  build:
    timeout-minutes: 3
    name: Build
    runs-on: ubuntu-latest
    needs: [checkCommitMessage, typecheck, lint, test]
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/prepare
      - name: Build
        id: pnpm-build
        run: pnpm build

      # This will fail the workflow if the `dist/` directory is different than
      # expected.
      - name: Compare Directories
        id: diff
        run: |
          if [ ! -d dist/ ]; then
            echo "Expected dist/ directory does not exist.  See status below:"
            ls -la ./
            exit 1
          fi
          if [ "$(git diff --ignore-space-at-eol --text dist/ | wc -l)" -gt "0" ]; then
            echo "Detected uncommitted changes after build. See status below:"
            git diff --ignore-space-at-eol --text dist/
            exit 1
          fi
